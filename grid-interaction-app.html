<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edición de Muestras</title>
    <!-- Bibliotecas externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .grid-row {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            gap: 35px;
            margin-bottom: 25px;
            justify-content: center;
        }
        
        .grid {
            border: 2px solid #ff6666;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            background-color: rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .cell {
            border: 1px solid #ff9999;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .start-point {
            background-color: rgba(76, 175, 80, 0.8) !important;
        }
        
        .path {
            background-color: rgba(33, 150, 243, 0.7) !important;
        }
        
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .file-label:hover {
            background-color: #0b7dda;
        }
        
        .status {
            margin-left: 20px;
            color: #666;
        }
        
        .instructions {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        #savePdfButton {
            background-color: #FF5722;
        }
        
        #savePdfButton:hover {
            background-color: #E64A19;
        }
        
        .overlay-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            z-index: 100;
        }
        
        #uploadedContent {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }
        
        .file-viewer {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Edición de Muestras</h1>
        
        <div class="instructions">
            <h3>Instrucciones:</h3>
            <ol>
                <li>Carga tu archivo de rejillas (requerido).</li>
                <li>Una vez cargado, marca un punto de inicio (verde) en cada rejilla de la primera fila.</li>
                <li>Dibuja un trazo (azul) en cada rejilla de la primera fila.</li>
                <li>El sistema marcará automáticamente el mismo punto verde en las rejillas correspondientes de las filas inferiores.</li>
            </ol>
        </div>
        
        <div class="controls">
            <label class="file-label" for="gridFile">Cargar archivo de rejillas</label>
            <input type="file" id="gridFile" accept=".pdf,.jpg,.jpeg,.png">
            <span class="status" id="fileStatus">Ningún archivo cargado</span>
        </div>
        
        <div class="button-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="resetButton">Reiniciar Marcadores</button>
            <button id="savePdfButton">Guardar como PDF</button>
        </div>
        
        <div id="appContent">
            <!-- Aquí se mostrará el contenido cargado y las rejillas -->
            <div id="messageDiv" style="text-align: center; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
                Por favor, carga un archivo de rejillas para comenzar.
            </div>
        </div>
    </div>

    <script>
        // Configuración inicial
        const rows = 13;
        const columns = 9;
        const gridSize = 5;
        
        // Estado de la aplicación
        let firstRowStartPoints = Array(columns).fill(null);
        let paths = Array(rows).fill().map(() => Array(columns).fill().map(() => []));
        let currentGrid = null;
        let isDrawing = false;
        
        // Manejar carga de archivo
        document.getElementById('gridFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Reiniciamos el estado de la aplicación al cargar un nuevo archivo
                firstRowStartPoints = Array(columns).fill(null);
                paths = Array(rows).fill().map(() => Array(columns).fill().map(() => []));
                currentGrid = null;
                isDrawing = false;
                
                document.getElementById('fileStatus').textContent = `Archivo cargado: ${file.name}`;
                
                // Mostramos la imagen cargada
                const reader = new FileReader();
                reader.onload = function(event) {
                    const appContent = document.getElementById('appContent');
                    appContent.innerHTML = ''; // Limpiamos el contenido anterior
                    
                    // Creamos el contenedor para visualizar el archivo
                    const fileViewer = document.createElement('div');
                    fileViewer.className = 'file-viewer';
                    
                    // Si es un PDF, usamos un iframe para mejor visualización
                    if (file.type === 'application/pdf') {
                        const iframe = document.createElement('iframe');
                        iframe.src = event.target.result;
                        iframe.id = 'uploadedContent';
                        iframe.style.width = '100%';
                        iframe.style.height = '800px';
                        iframe.style.border = 'none';
                        
                        fileViewer.appendChild(iframe);
                        appContent.appendChild(fileViewer);
                        
                        // Esperamos a que el PDF se cargue y se renderice
                        iframe.onload = function() {
                            // Aumentamos el tiempo para permitir que el PDF se renderice
                            setTimeout(() => {
                                createGridOverlay();
                            }, 1500);
                        };
                    } else {
                        // Para imágenes
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.id = 'uploadedContent';
                        img.style.width = '100%';
                        img.style.objectFit = 'contain';
                        
                        fileViewer.appendChild(img);
                        appContent.appendChild(fileViewer);
                        
                        img.onload = function() {
                            createGridOverlay();
                        };
                    }
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        // Crear rejillas sobre el archivo visualizado
        function createGridOverlay() {
            // Obtenemos el contenedor y el elemento visualizado
            const fileViewer = document.querySelector('.file-viewer');
            const uploadedContent = document.getElementById('uploadedContent');
            
            // Verificar si es un iframe (PDF)
            const isPDF = uploadedContent.tagName.toLowerCase() === 'iframe';
            
            // Determinamos el elemento donde se crearán las rejillas
            let targetElement = fileViewer;
            
            // Si es un iframe (PDF), necesitamos un enfoque diferente
            if (isPDF) {
                // Para iframe, creamos un div posicionado encima
                const overlayDiv = document.createElement('div');
                overlayDiv.style.position = 'absolute';
                overlayDiv.style.top = uploadedContent.offsetTop + 'px';
                overlayDiv.style.left = uploadedContent.offsetLeft + 'px';
                overlayDiv.style.width = uploadedContent.offsetWidth + 'px';
                overlayDiv.style.height = uploadedContent.offsetHeight + 'px';
                overlayDiv.style.pointerEvents = 'none'; // Permite interactuar con el PDF
                
                // Añadimos este overlay al contenedor
                if (fileViewer.style.position !== 'relative') {
                    fileViewer.style.position = 'relative';
                }
                
                fileViewer.appendChild(overlayDiv);
                targetElement = overlayDiv;
            }
            
            // Creamos el contenedor para las rejillas
            const gridOverlay = document.createElement('div');
            gridOverlay.className = 'grid-overlay';
            gridOverlay.style.position = 'absolute';
            gridOverlay.style.top = '0';
            gridOverlay.style.left = '0';
            gridOverlay.style.width = '100%';
            gridOverlay.style.height = '100%';
            gridOverlay.style.pointerEvents = 'auto';
            
            // Configuramos las dimensiones de las rejillas basándonos en el archivo
            const docWidth = uploadedContent.offsetWidth;
            const docHeight = uploadedContent.offsetHeight;
            
            // Para PDFs, ajustamos a la primera página visible
            const verticalOffset = isPDF ? docHeight * 0.08 : docHeight * 0.05;
            const horizontalMargin = docWidth * 0.05;
            
            // Calculamos área disponible para las rejillas
            const gridAreaWidth = docWidth - (horizontalMargin * 2);
            const gridAreaHeight = docHeight - (verticalOffset * 2);
            
            // Tamaño de cada rejilla individual
            const gridSize = Math.min(
                (gridAreaWidth / columns) * 0.7,
                (gridAreaHeight / rows) * 0.7
            );
            
            // Espaciado horizontal y vertical total disponible
            const totalHorizontalSpacing = gridAreaWidth - (gridSize * columns);
            const totalVerticalSpacing = gridAreaHeight - (gridSize * rows);
            
            // Espaciado entre rejillas individuales
            const horizontalSpacing = totalHorizontalSpacing / (columns - 1 + 2); // +2 para márgenes
            const verticalSpacing = totalVerticalSpacing / (rows - 1 + 2);        // +2 para márgenes
            
            // Posición inicial (ajustada con margen)
            const startX = horizontalMargin + horizontalSpacing;
            const startY = verticalOffset + verticalSpacing;
            
            console.log('Dimensiones calculadas:', {
                docWidth, docHeight,
                startX, startY,
                gridSize,
                horizontalSpacing, verticalSpacing
            });
            
            // Creamos las rejillas
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'grid';
                    gridDiv.dataset.row = r;
                    gridDiv.dataset.col = c;
                    
                    // Posicionamos cada rejilla
                    const posX = startX + c * (gridSize + horizontalSpacing);
                    const posY = startY + r * (gridSize + verticalSpacing);
                    
                    gridDiv.style.position = 'absolute';
                    gridDiv.style.left = posX + 'px';
                    gridDiv.style.top = posY + 'px';
                    gridDiv.style.width = gridSize + 'px';
                    gridDiv.style.height = gridSize + 'px';
                    
                    // Creamos las celdas 5x5 dentro de cada rejilla
                    for (let i = 0; i < 5; i++) {
                        for (let j = 0; j < 5; j++) {
                            const cell = document.createElement('div');
                            cell.className = 'cell';
                            cell.dataset.row = i;
                            cell.dataset.col = j;
                            
                            // Solo la primera fila permite interacción completa
                            if (r === 0) {
                                cell.addEventListener('mousedown', startDrawing);
                                cell.addEventListener('mousemove', draw);
                                cell.addEventListener('mouseup', stopDrawing);
                                cell.addEventListener('mouseleave', leaveCell);
                            }
                            
                            gridDiv.appendChild(cell);
                        }
                    }
                    
                    gridOverlay.appendChild(gridDiv);
                }
            }
            
            targetElement.appendChild(gridOverlay);
            
            // Actualizamos los marcadores
            updateGrids();
        }
        
        // Iniciar dibujo
        function startDrawing(e) {
            if (e.target.classList.contains('cell')) {
                const gridDiv = e.target.closest('.grid');
                const gridRow = parseInt(gridDiv.dataset.row);
                const gridCol = parseInt(gridDiv.dataset.col);
                const cellRow = parseInt(e.target.dataset.row);
                const cellCol = parseInt(e.target.dataset.col);
                
                if (gridRow === 0) {
                    isDrawing = true;
                    currentGrid = { row: gridRow, col: gridCol };
                    
                    // Establecer punto de inicio (verde)
                    firstRowStartPoints[gridCol] = { row: cellRow, col: cellCol };
                    
                    // Iniciar nuevo trazo
                    paths[gridRow][gridCol] = [{ row: cellRow, col: cellCol }];
                    
                    updateGrids();
                }
            }
        }
        
        // Dibujar al mover el ratón
        function draw(e) {
            if (isDrawing && e.target.classList.contains('cell')) {
                const gridDiv = e.target.closest('.grid');
                const gridRow = parseInt(gridDiv.dataset.row);
                const gridCol = parseInt(gridDiv.dataset.col);
                const cellRow = parseInt(e.target.dataset.row);
                const cellCol = parseInt(e.target.dataset.col);
                
                if (gridRow === currentGrid.row && gridCol === currentGrid.col) {
                    // Añadir al trazo actual
                    const lastPoint = paths[gridRow][gridCol][paths[gridRow][gridCol].length - 1];
                    
                    // Evitar duplicados consecutivos
                    if (lastPoint.row !== cellRow || lastPoint.col !== cellCol) {
                        paths[gridRow][gridCol].push({ row: cellRow, col: cellCol });
                        updateGrids();
                    }
                }
            }
        }
        
        // Detener dibujo
        function stopDrawing() {
            isDrawing = false;
            currentGrid = null;
        }
        
        // Salir de una celda
        function leaveCell(e) {
            // No hacemos nada especial aquí, solo controlamos el evento
        }
        
        // Actualizar la visualización de las rejillas
        function updateGrids() {
            const allGrids = document.querySelectorAll('.grid');
            
            allGrids.forEach(grid => {
                const gridRow = parseInt(grid.dataset.row);
                const gridCol = parseInt(grid.dataset.col);
                
                // Limpiar todas las celdas
                grid.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('start-point', 'path');
                });
                
                // Aplicar punto de inicio si existe
                if (firstRowStartPoints[gridCol] !== null) {
                    const startPoint = firstRowStartPoints[gridCol];
                    const startCell = grid.querySelector(`.cell[data-row="${startPoint.row}"][data-col="${startPoint.col}"]`);
                    if (startCell) {
                        startCell.classList.add('start-point');
                    }
                }
                
                // Aplicar trazos solo a la primera fila
                if (gridRow === 0 && paths[gridRow][gridCol] && paths[gridRow][gridCol].length > 0) {
                    paths[gridRow][gridCol].forEach(point => {
                        const pathCell = grid.querySelector(`.cell[data-row="${point.row}"][data-col="${point.col}"]`);
                        if (pathCell && !pathCell.classList.contains('start-point')) {
                            pathCell.classList.add('path');
                        }
                    });
                }
            });
        }
        
        // Función para guardar como PDF
        document.getElementById('savePdfButton').addEventListener('click', function() {
            const appContent = document.getElementById('appContent');
            if (!appContent.querySelector('.file-viewer')) {
                alert('Por favor, carga un archivo primero.');
                return;
            }
            
            // Crear un título para el PDF
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = '<h2 style="text-align: center; margin-bottom: 20px;">Hoja de Práctica - Cajas 5x5</h2>';
            
            // Crear una copia del contenido para el PDF
            const contentDiv = document.createElement('div');
            contentDiv.appendChild(titleDiv);
            
            // Hacer una captura de la página actual con html2canvas
            html2canvas(document.querySelector('.overlay-container')).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const img = document.createElement('img');
                img.src = imgData;
                img.style.width = '100%';
                
                contentDiv.appendChild(img);
                
                // Opciones para el PDF
                const options = {
                    margin: [10, 10],
                    filename: 'rejillas_5x5.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generar el PDF
                html2pdf().from(contentDiv).set(options).save();
            });
        });
        
        // Reiniciar marcadores
        document.getElementById('resetButton').addEventListener('click', function() {
            firstRowStartPoints = Array(columns).fill(null);
            paths = Array(rows).fill().map(() => Array(columns).fill().map(() => []));
            updateGrids();
        });
    </script>
</body>
</html>
