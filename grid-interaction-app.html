<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edición de Muestras</title>
    <!-- Bibliotecas externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .grid-row {
            display: flex;
            flex-wrap: wrap;
            width: 100%;
            gap: 35px;
            margin-bottom: 25px;
            justify-content: center;
        }
        
        .grid {
            border: 2px solid #ff6666;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            background-color: rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .cell {
            border: 1px solid #ff9999;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .start-point {
            background-color: rgba(76, 175, 80, 0.8) !important;
        }
        
        .path {
            background-color: rgba(33, 150, 243, 0.7) !important;
        }
        
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            padding: 10px 15px;
            background-color: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .file-label:hover {
            background-color: #0b7dda;
        }
        
        .status {
            margin-left: 20px;
            color: #666;
        }
        
        .instructions {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        #savePdfButton {
            background-color: #FF5722;
        }
        
        #savePdfButton:hover {
            background-color: #E64A19;
        }
        
        .overlay-container {
            position: relative;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
            z-index: 100;
        }
        
        #uploadedContent {
            max-width: 100%;
            display: block;
            margin: 0 auto;
        }
        
        .file-viewer {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Edición de Muestras</h1>
        
        <div class="instructions">
            <h3>Instrucciones:</h3>
            <ol>
                <li>Carga tu archivo de rejillas (requerido).</li>
                <li>Una vez cargado, marca un punto de inicio (verde) en cada rejilla de la primera fila.</li>
                <li>Dibuja un trazo (azul) en cada rejilla de la primera fila.</li>
                <li>El sistema marcará automáticamente el mismo punto verde en las rejillas correspondientes de las filas inferiores.</li>
            </ol>
        </div>
        
        <div class="controls">
            <label class="file-label" for="gridFile">Cargar archivo de rejillas</label>
            <input type="file" id="gridFile" accept=".pdf,.jpg,.jpeg,.png">
            <span class="status" id="fileStatus">Ningún archivo cargado</span>
        </div>
        
        <div class="button-group" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="resetButton">Reiniciar Marcadores</button>
            <button id="savePdfButton">Guardar como PDF</button>
        </div>
        
        <div id="appContent">
            <!-- Aquí se mostrará el contenido cargado y las rejillas -->
            <div id="messageDiv" style="text-align: center; padding: 20px; background-color: #f5f5f5; border-radius: 8px;">
                Por favor, carga un archivo de rejillas para comenzar.
            </div>
        </div>
    </div>

    <script>
        // Configuración inicial
        const rows = 13;
        const columns = 9;
        const gridSize = 5;
        
        // Estado de la aplicación
        let firstRowStartPoints = Array(columns).fill(null);
        let paths = Array(rows).fill().map(() => Array(columns).fill().map(() => []));
        let currentGrid = null;
        let isDrawing = false;
        
        // Manejar carga de archivo
        document.getElementById('gridFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Reiniciamos el estado de la aplicación al cargar un nuevo archivo
                firstRowStartPoints = Array(columns).fill(null);
                paths = Array(rows).fill().map(() => Array(columns).fill().map(() => []));
                currentGrid = null;
                isDrawing = false;
                
                document.getElementById('fileStatus').textContent = `Archivo cargado: ${file.name}`;
                
                // Mostramos la imagen cargada
                const reader = new FileReader();
                reader.onload = function(event) {
                    const appContent = document.getElementById('appContent');
                    appContent.innerHTML = ''; // Limpiamos el contenido anterior
                    
                    // Creamos el contenedor para visualizar el archivo
                    const fileViewer = document.createElement('div');
                    fileViewer.className = 'file-viewer';
                    
                    // Si es un PDF, usamos un objeto para mostrarlo
                    if (file.type === 'application/pdf') {
                        // Para PDFs, intentamos mantener la proporción exacta de A4
                        const pdfContainer = document.createElement('div');
                        pdfContainer.style.width = '100%';
                        pdfContainer.style.position = 'relative';
                        pdfContainer.style.paddingBottom = '141.4%'; // Proporción A4 (1:√2)
                        pdfContainer.style.overflow = 'hidden';
                        
                        const pdfObj = document.createElement('object');
                        pdfObj.data = event.target.result;
                        pdfObj.type = 'application/pdf';
                        pdfObj.id = 'uploadedContent';
                        pdfObj.style.position = 'absolute';
                        pdfObj.style.top = '0';
                        pdfObj.style.left = '0';
                        pdfObj.style.width = '100%';
                        pdfObj.style.height = '100%';
                        
                        pdfContainer.appendChild(pdfObj);
                        fileViewer.appendChild(pdfContainer);
                        appContent.appendChild(fileViewer);
                        
                        // Esperamos a que el PDF se cargue y se renderice
                        setTimeout(() => {
                            createGridOverlay();
                        }, 1000);
                    } else {
                        // Para imágenes
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.id = 'uploadedContent';
                        img.style.width = '100%';
                        img.style.objectFit = 'contain';
                        
                        fileViewer.appendChild(img);
                        appContent.appendChild(fileViewer);
                        
                        img.onload = function() {
                            createGridOverlay();
                        };
                    }
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        // Crear rejillas sobre el archivo visualizado
        function createGridOverlay() {
            // Obtenemos el contenedor y el elemento visualizado
            const fileViewer = document.querySelector('.file-viewer');
            const uploadedContent = document.getElementById('uploadedContent');
            
            // Creamos un contenedor para el overlay
            const overlayContainer = document.createElement('div');
            overlayContainer.className = 'overlay-container';
            overlayContainer.style.width = fileViewer.offsetWidth + 'px';
            overlayContainer.style.height = fileViewer.offsetHeight + 'px';
            
            // Copiamos la imagen o PDF para que esté debajo del overlay
            const contentClone = uploadedContent.cloneNode(true);
            overlayContainer.appendChild(contentClone);
            
            // Creamos el overlay de rejillas
            const gridOverlay = document.createElement('div');
            gridOverlay.className = 'grid-overlay';
            gridOverlay.style.width = contentClone.offsetWidth + 'px';
            gridOverlay.style.height = contentClone.offsetHeight + 'px';
            
            // Determinamos si es un PDF por el tipo de elemento
            const isPDF = contentClone.tagName.toLowerCase() === 'object';
            
            // Proporciones para rejillas en PDF - estas deben coincidir exactamente con las del archivo
            // Valores específicos para el archivo de muestra proporcionado (13 filas x 9 columnas)
            let startX, startY, gridWidth, gridHeight, xSpacing, ySpacing;
            
            if (isPDF) {
                // Para PDF de ejemplo (ajustar según el documento específico)
                const contentWidth = contentClone.offsetWidth;
                const contentHeight = contentClone.offsetHeight;
                
                // Proporciones basadas en el archivo de muestra (observación del PDF)
                startX = contentWidth * 0.07;       // 7% desde el margen izquierdo
                startY = contentHeight * 0.05;      // 5% desde el margen superior
                
                // Tamaño total del área de rejillas (basado en observación del PDF)
                const gridAreaWidth = contentWidth * 0.86;   // 86% del ancho total
                const gridAreaHeight = contentHeight * 0.89; // 89% del alto total
                
                // Calcular tamaño de rejilla y espaciado
                gridWidth = gridAreaWidth / columns * 0.45;  // Tamaño de cada rejilla (anchura)
                gridHeight = gridWidth;                      // Mantener cuadrado
                
                // Espaciado horizontal y vertical entre rejillas
                xSpacing = (gridAreaWidth - (gridWidth * columns)) / (columns - 1);
                ySpacing = (gridAreaHeight - (gridHeight * rows)) / (rows - 1);
            } else {
                // Para imágenes (usando proporciones similares pero adaptadas)
                const contentWidth = contentClone.offsetWidth;
                const contentHeight = contentClone.offsetHeight;
                
                startX = contentWidth * 0.08;
                startY = contentHeight * 0.06;
                
                const gridAreaWidth = contentWidth * 0.84;
                const gridAreaHeight = contentHeight * 0.88;
                
                gridWidth = gridAreaWidth / columns * 0.45;
                gridHeight = gridWidth;
                
                xSpacing = (gridAreaWidth - (gridWidth * columns)) / (columns - 1);
                ySpacing = (gridAreaHeight - (gridHeight * rows)) / (rows - 1);
            }
            
            console.log("Dimensiones calculadas:", {
                startX, startY,
                gridWidth, gridHeight,
                xSpacing, ySpacing
            });
            
            // Creamos las rejillas
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < columns; c++) {
                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'grid';
                    gridDiv.dataset.row = r;
                    gridDiv.dataset.col = c;
                    
                    // Posicionamos la rejilla usando el espaciado calculado
                    const posX = startX + c * (gridWidth + xSpacing);
                    const posY = startY + r * (gridHeight + ySpacing);
                    
                    gridDiv.style.position = 'absolute';
                    gridDiv.style.left = posX + 'px';
                    gridDiv.style.top = posY + 'px';
                    gridDiv.style.width = gridWidth + 'px';
                    gridDiv.style.height = gridHeight + 'px';
                    
                    // Creamos las celdas 5x5 dentro de cada rejilla
                    for (let i = 0; i < gridSize; i++) {
                        for (let j = 0; j < gridSize; j++) {
                            const cell = document.createElement('div');
                            cell.className = 'cell';
                            cell.dataset.row = i;
                            cell.dataset.col = j;
                            
                            // Solo la primera fila permite interacción completa
                            if (r === 0) {
                                cell.addEventListener('mousedown', startDrawing);
                                cell.addEventListener('mousemove', draw);
                                cell.addEventListener('mouseup', stopDrawing);
                                cell.addEventListener('mouseleave', leaveCell);
                            }
                            
                            gridDiv.appendChild(cell);
                        }
                    }
                    
                    gridOverlay.appendChild(gridDiv);
                }
            }
            
            overlayContainer.appendChild(gridOverlay);
            
            // Reemplazamos el contenido del visor con el overlay
            fileViewer.innerHTML = '';
            fileViewer.appendChild(overlayContainer);
            
            // Actualizamos los marcadores
            updateGrids();
        }
        
        // Iniciar dibujo
        function startDrawing(e) {
            if (e.target.classList.contains('cell')) {
                const gridDiv = e.target.closest('.grid');
                const gridRow = parseInt(gridDiv.dataset.row);
                const gridCol = parseInt(gridDiv.dataset.col);
                const cellRow = parseInt(e.target.dataset.row);
                const cellCol = parseInt(e.target.dataset.col);
                
                if (gridRow === 0) {
                    isDrawing = true;
                    currentGrid = { row: gridRow, col: gridCol };
                    
                    // Establecer punto de inicio (verde)
                    firstRowStartPoints[gridCol] = { row: cellRow, col: cellCol };
                    
                    // Iniciar nuevo trazo
                    paths[gridRow][gridCol] = [{ row: cellRow, col: cellCol }];
                    
                    updateGrids();
                }
            }
        }
        
        // Dibujar al mover el ratón
        function draw(e) {
            if (isDrawing && e.target.classList.contains('cell')) {
                const gridDiv = e.target.closest('.grid');
                const gridRow = parseInt(gridDiv.dataset.row);
                const gridCol = parseInt(gridDiv.dataset.col);
                const cellRow = parseInt(e.target.dataset.row);
                const cellCol = parseInt(e.target.dataset.col);
                
                if (gridRow === currentGrid.row && gridCol === currentGrid.col) {
                    // Añadir al trazo actual
                    const lastPoint = paths[gridRow][gridCol][paths[gridRow][gridCol].length - 1];
                    
                    // Evitar duplicados consecutivos
                    if (lastPoint.row !== cellRow || lastPoint.col !== cellCol) {
                        paths[gridRow][gridCol].push({ row: cellRow, col: cellCol });
                        updateGrids();
                    }
                }
            }
        }
        
        // Detener dibujo
        function stopDrawing() {
            isDrawing = false;
            currentGrid = null;
        }
        
        // Salir de una celda
        function leaveCell(e) {
            // No hacemos nada especial aquí, solo controlamos el evento
        }
        
        // Actualizar la visualización de las rejillas
        function updateGrids() {
            const allGrids = document.querySelectorAll('.grid');
            
            allGrids.forEach(grid => {
                const gridRow = parseInt(grid.dataset.row);
                const gridCol = parseInt(grid.dataset.col);
                
                // Limpiar todas las celdas
                grid.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('start-point', 'path');
                });
                
                // Aplicar punto de inicio si existe
                if (firstRowStartPoints[gridCol] !== null) {
                    const startPoint = firstRowStartPoints[gridCol];
                    const startCell = grid.querySelector(`.cell[data-row="${startPoint.row}"][data-col="${startPoint.col}"]`);
                    if (startCell) {
                        startCell.classList.add('start-point');
                    }
                }
                
                // Aplicar trazos solo a la primera fila
                if (gridRow === 0 && paths[gridRow][gridCol] && paths[gridRow][gridCol].length > 0) {
                    paths[gridRow][gridCol].forEach(point => {
                        const pathCell = grid.querySelector(`.cell[data-row="${point.row}"][data-col="${point.col}"]`);
                        if (pathCell && !pathCell.classList.contains('start-point')) {
                            pathCell.classList.add('path');
                        }
                    });
                }
            });
        }
        
        // Función para guardar como PDF
        document.getElementById('savePdfButton').addEventListener('click', function() {
            const appContent = document.getElementById('appContent');
            if (!appContent.querySelector('.file-viewer')) {
                alert('Por favor, carga un archivo primero.');
                return;
            }
            
            // Crear un título para el PDF
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = '<h2 style="text-align: center; margin-bottom: 20px;">Hoja de Práctica - Cajas 5x5</h2>';
            
            // Crear una copia del contenido para el PDF
            const contentDiv = document.createElement('div');
            contentDiv.appendChild(titleDiv);
            
            // Hacer una captura de la página actual con html2canvas
            html2canvas(document.querySelector('.overlay-container')).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const img = document.createElement('img');
                img.src = imgData;
                img.style.width = '100%';
                
                contentDiv.appendChild(img);
                
                // Opciones para el PDF
                const options = {
                    margin: [10, 10],
                    filename: 'rejillas_5x5.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generar el PDF
                html2pdf().from(contentDiv).set(options).save();
            });
        });
        
        // Reiniciar marcadores
        document.getElementById('resetButton').addEventListener('click', function() {
            firstRowStartPoints = Array(columns).fill(null);
            paths = Array(rows).fill().map(() => Array(columns).fill().map(() => []));
            updateGrids();
        });
    </script>
</body>
</html>
